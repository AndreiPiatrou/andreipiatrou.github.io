<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="This is a repository for my thoughts, knowledge, and ideas that I want to share."><title>Protect your service with oauth2 proxy in docker container</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg-color: #0a0a0a;--text-color: #e0e0e0;--text-muted: #888;--accent-color: #fff;--border-color: #222;--code-bg: #1a1a1a}body{background-color:var(--bg-color);color:var(--text-color);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;line-height:1.6;font-size:16px}a{color:var(--text-color);text-decoration:none;border-bottom:1px solid var(--border-color);transition:border-color .2s}a:hover{border-bottom-color:var(--accent-color)}h1,h2,h3,h4,h5,h6{margin:1.5em 0 .5em;line-height:1.3;font-weight:600}h1{font-size:2em}h2{font-size:1.5em}h3{font-size:1.25em}p{margin:1em 0}ul,ol{margin:1em 0;padding-left:2em}li{margin:.5em 0}code{background-color:var(--code-bg);padding:.2em .4em;border-radius:3px;font-family:Courier New,monospace;font-size:.9em}pre{background-color:var(--code-bg);padding:1em;border-radius:5px;overflow-x:auto;margin:1em 0}pre code{padding:0;background:none}blockquote{border-left:3px solid var(--border-color);padding-left:1em;margin:1em 0;color:var(--text-muted)}hr{border:none;border-top:1px solid var(--border-color);margin:2em 0}img{max-width:100%;height:auto}table{width:100%;border-collapse:collapse;margin:1em 0}th,td{padding:.5em;border:1px solid var(--border-color);text-align:left}th{background-color:var(--code-bg)}
.container[data-astro-cid-bvzihdzo]{max-width:800px;margin:0 auto;padding:2rem 1.5rem}.site-header[data-astro-cid-bvzihdzo]{margin-bottom:3rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}.site-title[data-astro-cid-bvzihdzo]{font-size:1.5rem;margin:0}.site-title[data-astro-cid-bvzihdzo] a[data-astro-cid-bvzihdzo]{border:none}.post[data-astro-cid-bvzihdzo]{margin-bottom:3rem}.post-header[data-astro-cid-bvzihdzo]{margin-bottom:2rem}.post-title[data-astro-cid-bvzihdzo]{margin:0 0 .5rem;font-size:2.5rem}.post-meta[data-astro-cid-bvzihdzo]{color:var(--text-muted);font-size:.95rem}.post-tags[data-astro-cid-bvzihdzo]{margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap}.tag[data-astro-cid-bvzihdzo]{background-color:var(--code-bg);padding:.25rem .75rem;border-radius:3px;font-size:.85rem;color:var(--text-muted)}.post-content[data-astro-cid-bvzihdzo]{margin:2rem 0}.post-footer[data-astro-cid-bvzihdzo]{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border-color)}.back-link[data-astro-cid-bvzihdzo]{color:var(--text-muted);border:none;transition:color .2s}.back-link[data-astro-cid-bvzihdzo]:hover{color:var(--accent-color)}@media(max-width:768px){.container[data-astro-cid-bvzihdzo]{padding:1.5rem 1rem}.post-title[data-astro-cid-bvzihdzo]{font-size:2rem}}
</style></head> <body>  <div class="container" data-astro-cid-bvzihdzo> <header class="site-header" data-astro-cid-bvzihdzo> <h1 class="site-title" data-astro-cid-bvzihdzo><a href="/" data-astro-cid-bvzihdzo>Engineer's blog</a></h1> </header> <article class="post" data-astro-cid-bvzihdzo> <header class="post-header" data-astro-cid-bvzihdzo> <h1 class="post-title" data-astro-cid-bvzihdzo>Protect your service with oauth2 proxy in docker container</h1> <div class="post-meta" data-astro-cid-bvzihdzo> <time datetime="2018-07-19T00:00:00.000Z" data-astro-cid-bvzihdzo>July 19, 2018</time> </div> <div class="post-tags" data-astro-cid-bvzihdzo> <span class="tag" data-astro-cid-bvzihdzo>best-practices</span> </div> </header> <div class="post-content" data-astro-cid-bvzihdzo>  <h2 id="common-available-options">Common available options</h2>
<p>In case you need to protect your app with some oauth2 provider (facebook, github, Google) you have a couple of common options:</p>
<ul>
<li>implement your own oauth2 <em>middleware</em> (expressJS) / <em>filter</em> (ASP.NET MVC)</li>
<li>integrate any suitable library that provides such functionality</li>
<li>use reverse proxy utility that will stage behind your service and protect it from unauthorized requests</li>
</ul>
<p>From the title of this article you may guess that we will stick with the 3rd option since this is a most efficient and safe approach:</p>
<ul>
<li>no development time</li>
<li>provides almost all identity provides such as (google, facebook, github)</li>
<li>flexible enough to add your own providers if need</li>
<li>easy to replace/remove</li>
</ul>
<p>I was suggested to use <a href="https://github.com/bitly/oauth2_proxy">oauth2_proxy</a>. This is a simple reverse proxy that provides all the required functionality and also it has a pretty straightforward configuration. Here is an example:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># oauth_config.cfg</span></span>
<span class="line"><span></span></span>
<span class="line"><span>http_address = "0.0.0.0:8080"</span></span>
<span class="line"><span>redirect_url = "https://your-ste.com/oauth2/callback"</span></span>
<span class="line"><span>upstreams = [</span></span>
<span class="line"><span>    "http://127.0.0.1:8081/"</span></span>
<span class="line"><span>]</span></span>
<span class="line"><span>email_domains = [</span></span>
<span class="line"><span>    "gmail.com"</span></span>
<span class="line"><span>]</span></span>
<span class="line"><span>client_id = "some-id"</span></span>
<span class="line"><span>client_secret = "some-secret"</span></span>
<span class="line"><span>cookie_name = "_oauth2_proxy"</span></span>
<span class="line"><span>cookie_secret = "XXXXXXXXXX"</span></span></code></pre>
<h2 id="put-inside-docker-container">Put inside docker container</h2>
<p>Since docker does not support running multiple services inside one container out of the box (I know this is not a best practice on docker world) to do this you need to run in <code>CMD</code> a <code>.sh</code> file that does this trick for you.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># run-multiple-services.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">oauth2_proxy</span><span style="color:#79B8FF"> -config</span><span style="color:#9ECBFF"> "./oauth_config.cfg"</span><span style="color:#E1E4E8"> &#x26;</span></span>
<span class="line"><span style="color:#B392F0">npm</span><span style="color:#9ECBFF"> start</span><span style="color:#6A737D"> # for example we are trying to start a nodejs app on 8081 port</span></span></code></pre>
<p>and <code>Dockerfile</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="dockerfile"><code><span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> golang</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> curl -sL https://deb.nodesource.com/setup_9.x | bash -</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> apt-get install -y nodejs</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> go get -d -v github.com/bitly/oauth2_proxy</span></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> go install -v github.com/bitly/oauth2_proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">COPY</span><span style="color:#E1E4E8"> . /src/</span></span>
<span class="line"><span style="color:#F97583">WORKDIR</span><span style="color:#E1E4E8"> /src/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">RUN</span><span style="color:#E1E4E8"> npm install &#x26;&#x26; npm rebuild</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">EXPOSE</span><span style="color:#E1E4E8"> 8080</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">CMD</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">"bash"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"./run-multiple-services.sh"</span><span style="color:#E1E4E8">]</span></span></code></pre>
<p>That is it. Now you can deploy your app to any container-based cloud and enjoy your oauth2 authentication.</p>  </div> <footer class="post-footer" data-astro-cid-bvzihdzo> <a href="/" class="back-link" data-astro-cid-bvzihdzo>‚Üê Back to all posts</a> </footer> </article> </div>   </body></html>